<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>My Things</title>

    <!-- Bootstrap -->
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="bootstrap/bootstrap-4.1.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="font-awesome/fontawesome-free-5.0.13/web-fonts-with-css/css/fontawesome-all.min.css"></link>
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <script src="knockout/knockout-3.4.2/knockout-3.4.2.js"></script>
    <style>
    body {
          height: 100vh;
          padding-top: 4.5rem;
    }
    .mt-sub-a { margin-left: 15px; /* to indent sub categories */}
     div.mt-item-a {margin-left: 45px; /* to indent items */}
    .badge {float: right; /* to move the category totals to the right of the lists */}
    .mt-edit-field-button {float: right; /* move edit pencils  button to the right of field*/}
    .mt-trash, .mt-need {float: right;}
    .mt-dialog-input {width: 100%;}
    a.list-group-item { /* make category lists look like the alert */
      color: black !important;
    }
    a.list-group-item.active { /* to separate adjacent active items and override bold blue active color */
      background-color: #d6d8d9 !important;
      border-color: #c6c8c9 !important;
    }
    span.fa-pencil-alt {
      margin-right: 5px;
    }
    .fa-star {color: green;}
    html.waiting * {
      cursor: wait;
    }

    #itemDescription, #itemReview {
      height: 10vh;
    }
    #itemImage {
      width: 100%;
    }
    div.tooltip-inner {
      max-width: 350px;
    }
    </style>
  </head>
  <body>
    <div class="container-fluid" id="mainBody">
      <nav class="navbar navbar-expand-md navbar-light fixed-top bg-light nav-center">
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse justify-content-center" id="navbarCollapse">
          <ul class="navbar-nav">
            <li class="nav-item">
              <span class="nav-link">My</span>
            </li>
            <li class="nav-item">
              <select class="custom-select"
                      id="typesSelect">
                <!-- ko foreach: types -->
                  <option data-bind="text: type,
                                     value: type"></option>
                <!-- /ko -->
              </select>
            </li>
            <li class="nav-item">
              <span data-bind="visible: loggedIn">Welcome:
                <span data-bind="text: currentUser"></span>
              </span>
            </li>
            <a id="loginBtn"
               class="nav-link btn btn-sm"
               data-bind="text: (loggedIn() ? 'logout' : 'login'),
                          click: (loggedIn() ? logout : beginLogin)">
            </a>
          </ul>
        </div>
      </nav>
      <div id="alertBox" class="alert alert-dark" role="alert">
        &nbsp;
      </div>
      <div class="d-none d-sm-block">
        <div id="controls" class="row">
          <div class="col-4">
            <div class="btn-group btn-group-sm mt-add-buttons mb-1">
              <button
                data-bind="attr: {title: addMainLabel},
                          enable: enableAddMain(),
                          click: beginAddMain"
                data-toggle="tooltip"
                class="btn btn-secondary mr-1">
                <span class="fa fa-plus fa-xs">
                </span>
              </button>
              <button
                data-bind="attr: {title: addSubLabel},
                          enable: enableAddSub(),
                          click: beginAddSub"
                data-toggle="tooltip"
                class="btn btn-secondary mr-1">
                <span class="fa fa-plus fa-xs">
                </span>
              </button>
              <button
                data-bind="attr: {title: addItemLabel},
                          enable: enableAddItem(),
                          click: beginAddItem"
                data-toggle="tooltip"
                class="btn btn-secondary text-capitalize">
                <span class="fa fa-plus fa-xs">
                </span>
              </button>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <!-- begin col-3 for hierarchical category lists-->
        <div id="itemList" class="col col-sm-4">
          <!-- begin accordian main -->
          <div class="accordion" id="accordianMain" style="height: 75vh;overflow-y: scroll;">
            <!-- ko foreach: mainNodes -->
              <!-- begin card main -->
              <div class="card border-0">
                <span>
                  <i
                    data-bind="visible: ($root.selectedMainNode() ? ($root.selectedMainNode().id() === $data.id() ? true : false) : false),
                               attr:{title: 'Delete ' + $root.mainLabel()},
                               click: $root.beginDeleteMainNode"
                    class="fa fa-trash-alt fa-s ml-1 mr-1 mt-3 mt-trash"
                    data-toggle="tooltip"></i>
                    <i
                      data-bind="visible: ($root.selectedMainNode() ? ($root.selectedMainNode().id() === $data.id() ? true : false) : false),
                                 attr:{title: 'Edit ' + $root.mainLabel()},
                                 click: $root.beginEditMainNode"
                      class="fa fa-edit fa-s ml-1 mr-1 mt-3 mt-trash"
                      data-toggle="tooltip"></i>
                  <a data-bind="attr: { href: '#accordianCollapse_' + id(),
                                        'mt-data-id': id},
                                click: $root.handleMainClick"
                    class="list-group-item mt-main-a text-truncate border-0 mb-1" data-toggle="collapse">
                    <span>
                      <span class="badge badge-secondary"
                            data-bind="text: leavesNeeded,
                                       style:{'background-color': leavesNeeded() ? 'red' : 'green'}"
                            title="need"
                            data-toggle="tooltip"></span>
                      <i data-bind="attr: {class: 'fa ' + (collapsed() ? 'fa-plus' : 'fa-minus') + ' fa-xs',
                                        title: (collapsed() ? 'expand' : 'collapse')}"
                            data-toggle="tooltip"></i>
                      <i data-bind="style: {opacity: (leavesHaveTried() ? '1.0': '0.2'),
                                            color: (allLeavesHaveTried() ? 'green' : 'black')},
                                            attr: {class: (allLeavesHaveTried() ? 'fa fa-times fa-s' : 'fa fa-check fa-xs')}"
                            data-toggle="tooltip" title="tried"></i>
                      <span class="fa-stack fa-fw"
                            data-bind="style: {opacity: (leavesHaveRating() ? '1.0': '0.5')}"
                            data-toggle="tooltip" title="rating">
                        <i class="far fa-star fa-stack-2x pb-1"></i>
                        <i class="fa fa-text fa-xs pl-1"
                           data-bind="text: averageRating()"></i>
                      </span>
                      <span data-toggle="tooltip"
                            data-html="true"
                            data-bind="text: name,
                                       attr: {'data-original-title': nodeTooltip}"
                            data-boundary="viewport"
                            class="mt-tooltip">
                      </span>
                  </span>
                  </a>
                </span>
              </div>
              <!-- end card main -->
              <!-- begin sub node collapsed div -->
              <div data-bind="attr: { id: 'accordianCollapse_' + id() }"
                  class="collapse mt-main-collapse" data-parent="#accordianMain">
                <!-- begin sub accordian -->
                <div data-bind="attr: { id: 'accordian_' + id() }" class="accordion">
                  <!-- ko foreach: children -->
                    <!-- begin sub card -->
                    <div class="card border-0">
                      <span>
                        <i
                          data-bind="visible: ($root.selectedSubNode() ? ($root.selectedSubNode().id() === $data.id() ? true : false) : false),
                                     attr:{title: 'Delete ' + $root.subLabel()},
                                     click: $root.beginDeleteSubNode"
                          class="fa fa-trash-alt fa-s ml-1 mr-1 mt-3 mt-trash"
                          data-toggle="tooltip"></i>
                          <i
                            data-bind="visible: ($root.selectedSubNode() ? ($root.selectedSubNode().id() === $data.id() ? true : false) : false),
                                       attr:{title: 'Edit ' + $root.subLabel()},
                                       click: $root.beginEditSubNode"
                            class="fa fa-edit fa-s ml-1 mr-1 mt-3 mt-trash"
                            data-toggle="tooltip"></i>
                        <a data-bind="attr: { href: '#accordianCollapse_' + id(), 'mt-data-id': id},
                                      click: $root.handleSubClick"
                          class="list-group-item mt-sub-a text-truncate border-0 mb-1"  data-toggle="collapse">
                          <span>
                            <span class="badge badge-secondary"
                                  data-bind="text: leavesNeeded,
                                             style:{'background-color': leavesNeeded() ? 'red' : 'green'}"
                                  title="need"
                                  data-toggle="tooltip"></span>
                            <i data-bind="attr: {class: 'fa ' + (collapsed() ? 'fa-plus' : 'fa-minus') + ' fa-xs',
                                              title: (collapsed() ? 'expand' : 'collapse')}"
                                  data-toggle="tooltip"></i>
                            <i data-bind="style: {opacity: (leavesHaveTried() ? '1.0': '0.2'),
                                                  color: (allLeavesHaveTried() ? 'green' : 'black')},
                                                  attr: {class: (allLeavesHaveTried() ? 'fa fa-times fa-s' : 'fa fa-check fa-xs')}"
                                  data-toggle="tooltip" title="tried"></i>
                            <span class="fa-stack fa-fw"
                                  data-bind="style: {opacity: (leavesHaveRating() ? '1.0': '0.5')}"
                                  data-toggle="tooltip" title="rating">
                              <i class="far fa-star fa-stack-2x pb-1"></i>
                              <i class="fa fa-text fa-xs pl-1"
                                 data-bind="text: averageRating()"></i>
                            </span>
                            <span data-toggle="tooltip"
                                  data-html="true"
                                  data-bind="text: name,
                                             attr: {'data-original-title': nodeTooltip}"
                                  data-boundary="viewport"
                                  class="mt-tooltip">
                            </span>
                          </span>
                        </a>
                      </span>
                      <!-- begin item card -->
                      <div class="card border-0">
                        <span>
                          <!-- begin item collapse -->
                          <div data-bind="attr: { id: 'accordianCollapse_' + id(),'data-parent': '#accordian_' + $parent.id() }"
                              class="collapse mt-sub-collapse mt-item-a">
                            <!-- ko foreach: children -->
                            <i
                            data-bind="visible: ($root.selectedItem() ? ($root.selectedItem().id() === $data.id() ? true : false) : false),
                                       attr:{title: 'Delete ' + $root.itemLabel()},
                                       click: $root.beginDeleteItem"
                            class="fa fa-trash-alt fa-s ml-1 mr-1 mt-3 mt-trash"
                            data-toggle="tooltip"></i>
                            <i
                              data-bind="visible: ($root.selectedItem() ? ($root.selectedItem().id() === $data.id() ? true : false) : false),
                                         attr:{title: 'Edit ' + $root.itemLabel()},
                                         click: $root.beginEditItem"
                              class="fa fa-edit fa-s ml-1 mr-1 mt-3 mt-trash"
                              data-toggle="tooltip"></i>
                              <a data-bind="attr: { href: '#item_ ' + id(), 'mt-data-id': id},
                                           click: $root.handleItemClick"
                                class="list-group-item mt-item-a text-truncate border-0 mb-1" >
                                <span class="mt-item">
                                  <i data-bind="style: {opacity: ($root.selectedItem() && $root.selectedItem().id() === $data.id() ? '1.0': '0.2'),
                                                        color: (need() ? 'red': 'black')}"
                                        data-toggle="tooltip" title="need"
                                        class="mt-need fa fa-cart-plus fa-s"></i>
                                  <i data-bind="style: {opacity: (haveTried() ? '1.0': '0.2')}"
                                        data-toggle="tooltip" title="tried"
                                        class="fa fa-check fa-xs"></i>
                                  <span class="fa-stack fa-fw"
                                        data-bind="style: {opacity: (rating() !== null && rating() !== '' ? '1.0': '0.5')}"
                                        data-toggle="tooltip" title="rating">
                                    <i class="far fa-star fa-stack-2x pb-1"></i>
                                    <i class="fa fa-text fa-xs pl-1"
                                       data-bind="text: (rating() ? rating() : '')"></i>
                                  </span>
                                  <span data-bind="visible: sortIndex() !== null && sortIndex() !== ''" class="mr-1 ml-1">
                                    (<span data-bind="text: sortIndex"
                                           class="mt-tooltip"></span>)
                                  </span>
                                  <span data-toggle="tooltip"
                                        data-bind="text: name,
                                                   attr:{title: name,
                                                         'data-original-title': name,
                                                         'mt-data-id': id }"
                                        data-boundary="viewport">
                                  </span>
                                </span>
                              </a>
                            <!-- /ko -->
                          </div>
                        </span>
                        <!-- end item collapse -->
                      </div>
                      <!-- end item card -->
                    </div>
                    <!-- end sub card -->
                  <!-- /ko -->
                </div>
                <!-- end sub accordian -->
              </div>
              <!-- end sub node collapsed div -->
            <!-- /ko -->
          </div>
          <!-- end accordian main -->
        </div>
        <!-- end col-3 -->
        <!-- begin col-9 for item details -->
        <div  id="itemDetails" class="col-8 card"  style="height: 75vh;overflow-y: scroll;">
          <div class="d-none d-sm-block">
            <div class = "mt-item-form">
              <div class="row">
                <div class="col">
                  <input
                    id="mainName"
                    data-bind="attr: {title: (selectedMainNode() ? selectedMainNode().name : ''),
                                      'data-original-title': (selectedMainNode() ? selectedMainNode().name : ''),
                                      placeholder: mainLabel},
                              textInput: (selectedMainNode() ? selectedMainNode().name : '')"
                    type="text"
                    data-toggle="tooltip"
                    data-boundary="viewport"
                    class="form-control text-center"
                    disabled>
                  </input>
                </div>
                <div class="col">
                  <input
                    id="subName"
                    data-bind="attr: {title: (selectedSubNode() ? selectedSubNode().name : ''),
                                      'data-original-title': (selectedSubNode() ? selectedSubNode().name : ''),
                                      placeholder: subLabel},
                              textInput: (selectedSubNode() ? selectedSubNode().name : '')"
                    type="text"
                    data-toggle="tooltip"
                    data-boundary="viewport"
                    class="form-control text-center"
                    disabled>
                  </input>
                </div>
                <div class="col-1">
                  <input
                    id="itemSortIndex"
                    data-bind="attr: {title: sortIndexLabel,
                                      placeholder: '#'},
                              textInput: (selectedItem() ? selectedItem().sortIndex : ''),
                              visible: $root.type() === 'books' || $root.type() === 'videos'"
                    type="text"
                    data-toggle="tooltip"
                    data-boundary="viewport"
                    class="form-control text-center"
                    title="sort index"
                    disabled>
                  </input>
                </div>
                <div class="col">
                  <input
                    id="itemName"
                    data-bind="attr: {title: (selectedItem() ? selectedItem().name : ''),
                                      'data-original-title': (selectedItem() ? selectedItem().name : ''),
                                      placeholder: itemLabel},
                              textInput: (selectedItem() ? selectedItem().name : '')"
                    type="text"
                    data-toggle="tooltip"
                    data-boundary="viewport"
                    class="form-control text-center text"
                    disabled>
                  </input>
                </div>
                <div class="col-2 text-center">

                  <input id="tried"
                         data-bind="checked: (selectedItem() ? selectedItem().haveTried : false)"
                         class="checkbox"
                         type="checkbox"
                         disabled></input>
                  <label for="tried" class="label" data-bind="text: triedLabel"></label>
                </div>
              </div>
              <div class="row">
                <div class="col">
                  <div class="row">
                  <label for="nodeInfo1" class="col-2 label" data-bind="text: nodeInfo1Label() + ':'"></label>
                  <input id="nodeInfo1"
                         data-bind="textInput: (selectedItem() ? selectedItem().nodeInfo()[nodeInfo1Key()] : ''),
                                    attr:{placeholder: nodeInfo1Label()}"
                           class="col form-control"
                           type="text"
                           disabled></input>
                  </div>
                  <div class="row">
                    <label for="nodeInfo2" class="col-2 label" data-bind="text: nodeInfo2Label() + ':'"></label>
                    <input id="nodeInfo2"
                           data-bind="textInput: (selectedItem() ? selectedItem().nodeInfo()[nodeInfo2Key()] : ''),
                                      attr:{placeholder: nodeInfo2Label()}"
                           class="col form-control"
                           type="text"
                           disabled></input>
                  </div>
                  <div class="row">
                    <label for="nodeInfo3" class="col-2 label" data-bind="text: nodeInfo3Label() + ':'"></label>
                    <input id="nodeInfo3"
                           data-bind="textInput: (selectedItem() ? selectedItem().nodeInfo()[nodeInfo3Key()] : ''),
                                      attr:{placeholder: nodeInfo3Label()}"
                           class="col form-control"
                           type="text"
                           disabled></input>
                  </div>
                  <div class="row">
                    <label for="nodeInfo4" class="col-2 label" data-bind="text: nodeInfo4Label() + ':'"></label>
                    <input id="nodeInfo4"
                           data-bind="textInput: (selectedItem() ? selectedItem().nodeInfo()[nodeInfo4Key()] : ''),
                                      attr:{placeholder: nodeInfo4Label()}"
                           class="col form-control"
                           type="text"
                           disabled></input>
                  </div>
                  <div class="row">
                    <label for="nodeInfo5" class="col-2 label"
                           data-bind="text: nodeInfo5Label() + ':'"></label>
                    <input id="nodeInfo5"
                           data-bind="textInput: (selectedItem() ? selectedItem().nodeInfo()[nodeInfo5Key()] : ''),
                                      attr:{placeholder: nodeInfo5Label()}"
                           class="col form-control"
                           type="text"
                           disabled></input>
                  </div>
                  <div class="row">
                    <div class="col">
                      <label for="nodeInfo6" class="col-2 label" data-bind="text: nodeInfo6Label() + ':'"></label>
                      <a id="nodeInfo6"
                         data-bind="text: (selectedItem() ? selectedItem().name(): ''),
                                    attr: {href: (selectedItem() ? selectedItem().nodeInfo()[nodeInfo6Key()] : '')}"
                         target="_blank"
                         class="col">
                      </a>
                    </div>
                  </div>
                </div>
                <div class="col-2">
                  <input
                    id="triedDate"
                    data-bind="attr: {title: 'Date ' + triedLabel(),
                                      'data-original-title': 'Date ' + triedLabel(),
                                      placeholder: 'Date ' + triedLabel()},
                              textInput: (selectedItem() ? selectedItem().dateTried : '')"
                    type="text"
                    data-toggle="tooltip"
                    data-boundary="viewport"
                    class="form-control text-center"
                    disabled>
                  </input>
                  <img id="itemImage" class="img-responsive"
                       data-bind="attr:{src: (selectedItem() ? selectedItem().image : '')}"></img>
                  <button class="btn btn-secondary btn-sm mt-edit-field-button"
                          title="Edit image"
                          data-toggle="tooltip"
                          data-boundary="viewport"
                          data-bind="visible: false"
                          disabled>
                          <span class="fa fa-edit fa-xs"></span>
                  </button>
                </div>
              </div>
              <div class="row">
                <div class="col">
                  <label for="itemDescription" class="label">Description:</label>
                  <textarea
                    id="itemDescription"
                    data-bind="textInput: (selectedItem() ? selectedItem().description : ''),
                               attr: {'data-original-title': (selectedItem() ? selectedItem().nodeDescriptionTooltip : '')}"
                    type="textarea"
                    data-toggle="tooltip"
                    data-boundary="viewport"
                    class="form-control text-wrap"
                    placeholder="Description"
                    disabled>
                  </textarea>
                </div>
              </div>
              <div class="row">
                <div class="col-1">
                  <label for="reviewedDate" class="label">Reviewed:</label>
                </div>
                <div class="col-2">
                  <input
                    id="reviewedDate"
                    data-bind="textInput: (selectedItem() ? selectedItem().dateReviewed : '')"
                    type="text"
                    data-toggle="tooltip"
                    data-boundary="viewport"
                    title="Review Date"
                    class="form-control text-center"
                    placeholder="Review Date"
                    disabled>
                  </input>
                </div>
                <div class="col-1 text-right">
                  <label for="rating" class="label">Rating(0-10):</label>
                </div>
                <div class="col-2">
                  <input
                    id="rating"
                    data-bind="textInput: (selectedItem() ? selectedItem().rating : '')"
                    type="text"
                    data-toggle="tooltip"
                    data-boundary="viewport"
                    title="Rating"
                    class="form-control text-center"
                    placeholder="Rating"
                    disabled>
                  </input>
                </div>
              </div>
              <div class="row">
                <div class="col">
                  <textarea
                    id="itemReview"
                    data-bind="textInput: (selectedItem() ? selectedItem().review : ''),
                               attr: {'data-original-title': (selectedItem() ? selectedItem().nodeReviewTooltip : '')}"
                    type="textarea"
                    data-toggle="tooltip"
                    data-boundary="viewport"
                    class="form-control text-wrap"
                    placeholder="Review"
                    disabled>
                  </textarea>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- end col-9 -->
      </div>
      <!-- end row -->
      <div id="confirmDeleteItem" class="modal hide fade" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Confirm</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Cancel">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <p>Warning! This will permanently remove the <span data-bind="text: nodesViewModel.itemLabel()"></span> from the database. Proceed?</p>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal" >Cancel Delete</button>
              <button type="button" class="btn btn-primary" data-dismiss="modal" data-bind="click: proceedWithItemDelete">Proceed</button>
            </div>
          </div>
        </div>
      </div>
      <div id="confirmDeleteMainNode" class="modal hide fade" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Confirm</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Cancel">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <p>Warning! This will permanently remove the <span data-bind="text: mainLabel"></span> and all <span data-bind="text: subLabel"></span> and <span data-bind="text: itemLabel"></span>s from the database. Proceed?</p>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal" >Cancel Delete</button>
              <button type="button" class="btn btn-primary" data-dismiss="modal" data-bind="click: proceedWithMainNodeDelete">Proceed</button>
            </div>
          </div>
        </div>
      </div>
      <div id="confirmDeleteSubNode" class="modal hide fade" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Confirm</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Cancel">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <p>Warning! This will permanently remove the <span data-bind="text: subLabel"></span> and all <span data-bind="text: itemLabel"></span>s from the database. Proceed?</p>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal" >Cancel Delete</button>
              <button type="button" class="btn btn-primary" data-dismiss="modal" data-bind="click: proceedWithSubNodeDelete">Proceed</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- end container-fluid -->
    <div id="editMainNode" class="modal hide fade" tabindex="-1" role="dialog">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Edit <span data-bind="text: (nodesViewModel.selectedMainNode() ? nodesViewModel.selectedMainNode().name() : '')"></span></h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Cancel">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form class="form-horizontal">
              <div class="control-group">
                <label class="control-label" for="editMainNodeName">Name</label>
                <div class="controls">
                  <input class="mt-dialog-input" data-bind="textInput: name" type="inputText" id="editMainNodeName" placeholder="Name">
                  </input>
                </div>
              </div>
              <div class="control-group">
                <label class="control-label" for="editMainNodeDescription">Description</label>
                <div class="controls">
                  <textarea class="mt-dialog-input" data-bind="textInput: description" id="editMainNodeDescription" placeholder="Description">
                  </textarea>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal" >Cancel</button>
            <button type="button" class="btn btn-primary" data-dismiss="modal" data-bind="click: editMainNode">Proceed</button>
          </div>
        </div>
      </div>
    </div>
    <div id="editSubNode" class="modal hide fade" tabindex="-1" role="dialog">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Edit <span data-bind="text: (nodesViewModel.selectedSubNode() ? nodesViewModel.selectedSubNode().name() : '')"></span></h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Cancel">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form class="form-horizontal">
              <div class="control-group">
                <label class="control-label" for="editSubNodeName">Name</label>
                <div class="controls">
                  <input class="mt-dialog-input" data-bind="textInput: name" type="inputText" id="editSubNodeName" placeholder="Name">
                  </input>
                </div>
              </div>
              <div class="control-group">
                <label class="control-label" for="editSubNodeDescription">Description</label>
                <div class="controls">
                  <textarea class="mt-dialog-input" data-bind="textInput: description" id="editSubNodeDescription" placeholder="Description">
                  </textarea>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal" >Cancel</button>
            <button type="button" class="btn btn-primary" data-dismiss="modal" data-bind="click: editSubNode">Proceed</button>
          </div>
        </div>
      </div>
    </div>
    <div id="editItemNode" class="modal hide fade" tabindex="-1" role="dialog">
      <div class="modal-dialog" role="document" style="width: 90%; max-width: 90%">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Cancel">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div id="editItemNodeAlertBox" class="alert alert-dark" role="alert">
              &nbsp;
            </div>
            <div class = "mt-item-edit-form">
              <div class="row">
                <div class="col">
                  <input
                    id="mainNodeName"
                    data-bind="attr: {'data-original-title': (mainNode() ? mainNode().name : ''),
                                      placeholder: nodesViewModel.mainLabel},
                              textInput: (mainNode() ? mainNode().name : '')"
                    type="text"
                    data-toggle="tooltip"
                    data-boundary="viewport"
                    class="form-control text-center"
                    disabled>
                  </input>
                </div>
                <div class="col">
                  <input
                    id="subNodeName"
                    data-bind="attr: {'data-original-title': (subNode() ? subNode().name : ''),
                                      placeholder: nodesViewModel.subLabel},
                              textInput: (subNode() ? subNode().name : '')"
                    type="text"
                    data-toggle="tooltip"
                    data-boundary="viewport"
                    class="form-control text-center"
                    disabled>
                  </input>
                </div>
                <div class="col-1">
                  <input
                    id="itemNodeSortIndex"
                    data-bind="attr: {title: nodesViewModel.sortIndexLabel,
                                      placeholder: '#'},
                              textInput: (itemNode() ? itemNode().sortIndex : ''),
                              visible: nodesViewModel.type() === 'books' || nodesViewModel.type() === 'videos'"
                    type="text"
                    data-toggle="tooltip"
                    data-boundary="viewport"
                    class="form-control text-center"
                    title="sort index">
                  </input>
                </div>
                <div class="col">
                  <input
                    id="itemNodeName"
                    data-bind="attr: {'data-original-title': (itemNode() ? itemNode().name : ''),
                                      placeholder: nodesViewModel.itemLabel},
                              textInput: (itemNode() ? itemNode().name : '')"
                    type="text"
                    data-toggle="tooltip"
                    data-boundary="viewport"
                    class="form-control text-center text">
                  </input>
                </div>
                <div class="col-2 text-center">
                  <input id="itemNodeTried"
                         data-bind="checked: (itemNode() ? itemNode().haveTried : false)"
                         class="checkbox"
                         type="checkbox"></input>
                  <label for="tried" class="label" data-bind="text: nodesViewModel.triedLabel"></label>
                </div>
              </div>
              <div class="row">
                <div class="col">
                  <div class="row">
                  <label for="itemNodeInfo1" class="col-2 label" data-bind="text: nodesViewModel.nodeInfo1Label() + ':'"></label>
                  <input id="itemNodeInfo1"
                         data-bind="textInput: (itemNode() ? itemNode().nodeInfo()[nodesViewModel.nodeInfo1Key()] : ''),
                                    attr:{placeholder: nodesViewModel.nodeInfo1Label()}"
                           class="col form-control"
                           type="text"></input>
                  </div>
                  <div class="row">
                    <label for="itemNodeInfo2" class="col-2 label" data-bind="text: nodesViewModel.nodeInfo2Label() + ':'"></label>
                    <input id="itemNodeInfo2"
                           data-bind="textInput: (itemNode() ? itemNode().nodeInfo()[nodesViewModel.nodeInfo2Key()] : ''),
                                      attr:{placeholder: nodesViewModel.nodeInfo2Label()}"
                           class="col form-control"
                           type="text"></input>
                  </div>
                  <div class="row">
                    <label for="itemNodeInfo3" class="col-2 label" data-bind="text: nodesViewModel.nodeInfo3Label() + ':'"></label>
                    <input id="itemNodeInfo3"
                           data-bind="textInput: (itemNode() ? itemNode().nodeInfo()[nodesViewModel.nodeInfo3Key()] : ''),
                                      attr:{placeholder: nodesViewModel.nodeInfo3Label()}"
                           class="col form-control"
                           type="text"></input>
                  </div>
                  <div class="row">
                    <label for="itemNodeInfo4" class="col-2 label" data-bind="text: nodesViewModel.nodeInfo4Label() + ':'"></label>
                    <input id="itemNodeInfo4"
                           data-bind="textInput: (itemNode() ? itemNode().nodeInfo()[nodesViewModel.nodeInfo4Key()] : ''),
                                      attr:{placeholder: nodesViewModel.nodeInfo4Label()}"
                           class="col form-control"
                           type="text"></input>
                    <button class="btn btn-secondary btn-sm col-1"
                       data-toggle="tooltip"
                       data-bind="click: fillItemFromGoogle,
                                  visible: nodesViewModel.type() === 'books',
                                  attr: {title: 'Attempt to fill information from books.google.com'}">
                       <span data-bind="html: nodesViewModel.fillItemFromGoogleIcon"></span>
                    </button>
                  </div>
                  <div class="row">
                    <label for="itemNodeInfo5" class="col-2 label"
                           data-bind="text: nodesViewModel.nodeInfo5Label() + ':'"></label>
                    <input id="itemNodeInfo5"
                           data-bind="textInput: (itemNode() ? itemNode().nodeInfo()[nodesViewModel.nodeInfo5Key()] : ''),
                                      attr:{placeholder: nodesViewModel.nodeInfo5Label()}"
                           class="col form-control"
                           type="text"></input>
                  </div>
                  <div class="row">
                    <label for="itemNodeInfo6" class="col-2 label" data-bind="text: nodesViewModel.nodeInfo6Label() + ':'"></label>
                    <input id="itemNodeInfo6"
                           data-bind="textInput: (itemNode() ? itemNode().nodeInfo()[nodesViewModel.nodeInfo6Key()] : ''),
                                      attr:{placeholder: nodesViewModel.nodeInfo6Label()}"
                           class="col form-control"
                           type="url"></input>
                  </div>
                </div>
                <div class="col-2">
                  <input
                    id="itemNodeTriedDate"
                    data-bind="attr: {title: 'Date ' + nodesViewModel.triedLabel(),
                                      'data-original-title': 'Date ' + nodesViewModel.triedLabel(),
                                      placeholder: 'Date ' + nodesViewModel.triedLabel()},
                              textInput: (itemNode() ? itemNode().dateTried : '')"
                    type="text"
                    data-toggle="tooltip"
                    data-boundary="viewport"
                    class="form-control text-center">
                  </input>
                  <img id="itemNodeImage" class="img-responsive"
                       data-bind="attr:{src: (itemNode() ? itemNode().image : '')}"></img>
                  <button class="btn btn-secondary btn-sm mt-edit-field-button"
                          title="Edit image"
                          data-toggle="tooltip"
                          data-boundary="viewport"
                          data-bind="click: nodesViewModel.editItemImage,
                                     visible: false">
                          <span class="fa fa-edit fa-xs"></span>
                  </button>
                </div>
              </div>
              <div class="row">
                <div class="col">
                  <label for="itemNodeDescription" class="label">Description:</label>
                  <textarea
                    id="itemNodeDescription"
                    data-bind="textInput: (itemNode() ? itemNode().description : ''),
                               attr: {'data-original-title': (itemNode() ? itemNode().nodeDescriptionTooltip : '')}"
                    type="textarea"
                    data-toggle="tooltip"
                    data-boundary="viewport"
                    class="form-control text-wrap"
                    placeholder="Description">
                  </textarea>
                </div>
              </div>
              <div class="row">
                <div class="col-1">
                  <label for="itemNodeReviewedDate" class="label">Reviewed:</label>
                </div>
                <div class="col-2">
                  <input
                    id="itemNodeReviewedDate"
                    data-bind="textInput: (itemNode() ? itemNode().dateReviewed : '')"
                    type="text"
                    data-toggle="tooltip"
                    data-boundary="viewport"
                    title="Review Date"
                    class="form-control text-center"
                    placeholder="Review Date">
                  </input>
                </div>
                <div class="col-1 text-right">
                  <label for="itemNodeRating" class="label">Rating(0-19):</label>
                </div>
                <div class="col-2">
                  <input
                    id="itemNodeRating"
                    data-bind="textInput: (itemNode() ? itemNode().rating : '')"
                    type="text"
                    data-toggle="tooltip"
                    data-boundary="viewport"
                    title="Rating"
                    class="form-control text-center"
                    placeholder="Rating">
                  </input>
                </div>
              </div>
              <div class="row">
                <div class="col">
                  <textarea
                    id="itemNodeReview"
                    data-bind="textInput: (itemNode() ? itemNode().review : ''),
                               attr: {'data-original-title': (itemNode() ? itemNode().nodeReviewTooltip : '')}"
                    type="textarea"
                    data-toggle="tooltip"
                    data-boundary="viewport"
                    class="form-control text-wrap"
                    placeholder="Review">
                  </textarea>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" data-bind="click: editItemNodeModel.saveItem">Save</button>
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
          </div>
        </div>
      </div>
    </div>
    <div id="confirmCancelItemEdit" class="modal hide fade" tabindex="-1" role="dialog">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Confirm</h5>
            <button type="button" class="close" data-dismiss="modal" data-bind="click: editItemNodeModel.continueItemEdit" aria-label="Cancel">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <p>Warning! You will lose current changes to <span data-bind="text: nodesViewModel.itemLabel"></span> item. Proceed and revert to previous data?</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal" data-bind="click: editItemNodeModel.continueItemEdit">Continue Editing</button>
            <button type="button" class="btn btn-primary" data-dismiss="modal" data-bind="click: editItemNodeModel.proceedWithCancelItemEdit">Proceed</button>
          </div>
        </div>
      </div>
    </div>
    <div id="editItemLink" class="modal hide fade" tabindex="-1" role="dialog">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Edit <span data-bind="text: nodesViewModel.itemLabel"></span> URL</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Cancel">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form class="form-horizontal">
              <div class="control-group">
                <label class="control-label" for="editLink">Name</label>
                <div class="controls">
                  <input class="mt-dialog-input" data-bind="textInput: itemLink" type="url" id="editLink" placeholder="URL">
                  </input>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal" >Cancel</button>
            <button type="button" class="btn btn-primary" data-dismiss="modal" data-bind="click: editItemLink">Proceed</button>
          </div>
        </div>
      </div>
    </div>
    <div id="addMainNode" class="modal hide fade" tabindex="-1" role="dialog">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Add <span data-bind="text: nodesViewModel.mainLabel"></span></h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Cancel">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form class="form-horizontal">
              <div class="control-group">
                <label class="control-label" for="inputMainNodeName">Name</label>
                <div class="controls">
                  <input class="mt-dialog-input" data-bind="textInput: name" type="inputText" id="inputMainNodeName" placeholder="Name">
                  </input>
                </div>
              </div>
              <div class="control-group">
                <label class="control-label" for="inputMainNodeDescription">Description</label>
                <div class="controls">
                  <textarea class="mt-dialog-input" data-bind="textInput: description" id="inputMainNodeDescription" placeholder="Description">
                  </textarea>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal" >Cancel</button>
            <button type="button" class="btn btn-primary" data-dismiss="modal" data-bind="click: addMainNode">Proceed</button>
          </div>
        </div>
      </div>
    </div>
    <div id="addSubNode" class="modal hide fade" tabindex="-1" role="dialog">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Add  <span data-bind="text: nodesViewModel.subLabel"></span></h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Cancel">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form class="form-horizontal">
              <div class="control-group">
                <label class="control-label" for="inputSubNodeName">Name</label>
                <div class="controls">
                  <input class="mt-dialog-input" data-bind="textInput: name" type="inputText" id="inputSubNodeName" placeholder="Name">
                  </input>
                </div>
              </div>
              <div class="control-group">
                <label class="control-label" for="inputSubNodeDescription">Description</label>
                <div class="controls">
                  <textarea class="mt-dialog-input" data-bind="textInput: description" id="inputSubNodeDescription" placeholder="Description">
                  </textarea>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal" >Cancel</button>
            <button type="button" class="btn btn-primary" data-dismiss="modal" data-bind="click: addSubNode">Proceed</button>
          </div>
        </div>
      </div>
    </div>
    <div id="login" class="modal hide fade" tabindex="-1" role="dialog">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Login</h5>
            <button type="button" class="close" data-dismiss="modal" data-bind="click: nodesViewModel.cancelLogin" aria-label="Cancel">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form class="form-horizontal">
              <div class="control-group">
                <label class="control-label" for="inputUsename">Username</label>
                <div class="controls">
                  <input class="mt-dialog-input" data-bind="textInput: username" type="inputText" id="inputUsername" placeholder="Username" autofocus>
                  </input>
                </div>
              </div>
              <div class="control-group">
                <label class="control-label" for="inputPassword">Description</label>
                <div class="controls">
                  <input class="mt-dialog-input" data-bind="textInput: password" type="password" id="inputPassword" placeholder="Password">
                </input>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bind="click: nodesViewModel.cancelLogin" data-dismiss="modal" >Cancel</button>
            <button type="button" class="btn btn-primary" data-dismiss="modal" data-bind="click: login">Proceed</button>
          </div>
        </div>
      </div>
    </div>
    <div class="modal hide" id="loadingDialog"  tabindex="-1" role="dialog">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5>Loading...</h5>
          </div>
          <div class="modal-body">
            <div class="progress">
              <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="jquery/jquery-3.3.1.min.js"></script>
    <script>
    // globals
    var nodesViewModel = null;
    var addMainNodeModel = null;
    var addSubNodeModel = null;
    var editMainNodeModel = null;
    var editSubNodeModel = null;
    var editItemLinkModel = null;
    var addTypeModel = null;
    var loginModel = null;
    var secrets = null;

    $('.fa, .far').css({'visibility':'hidden'});
    $('.mt-add-buttons, .mt-edit-buttons, .mt-item-form, .nav-item, .nav-link').css({'visibility':'hidden'});

    function setDefaultAlert() {
      setAlert(nodesViewModel.defaultAlert(),'','#alertBox');
    }

    function setAlert(alertText='', alertClass = '', alertId='#alertBox') {
      $('html').off('click', setDefaultAlert);
      if(alertClass !== '') {
        $('html').on('click', setDefaultAlert);
      }
      if(alertText === '') {
        alertText = '&nbsp;';
      }
       $(alertId).empty();
       $(alertId).removeClass (function (index, className) {
         return (className.match (/(^|\s)alert-\S+/g) || []).join(' ');
       });
       if( alertClass.length > 0) {
           $(alertId).addClass(alertClass);
       } else {
         $(alertId).addClass('alert-dark');
       };
       $(alertId).append('<span id="alertText"></span>');
       $(alertId + ' #alertText').html(alertText);
       if(alertClass !== "") {
         $(alertId).append(
           '<button type="button" class="close" aria-label="Close">' +
              '<span aria-hidden="true">&times;</span>' +
            '</button>' +
            '<span id="alertText"></span>'
          );
         $(alertId + ' button.close').on('click', function () {
             $(alertId).empty();
             $(alertId).removeClass (function (index, className) {
               return (className.match (/(^|\s)alert-\S+/g) || []).join(' ');
             });
             $(alertId).addClass('alert-dark');
             $(alertId).append(nodesViewModel.defaultAlert());
         })
       }
    }

    var Node = function(initialize=true, data={}) {
      var self = this;
      if(initialize) {
        self.children = ko.observableArray([]);
        self.collapsed = ko.observable(true);
        self.uneditedData = {};
        self.changed = false;
      }
      self.forgettableAspects = ['children', 'collapsed',
                                 'uneditedData', 'forgettableAspects',
                                 'changed', 'nodeTooltip', 'nodeDescriptionTooltip',
                                 'nodeReviewTooltip','leavesNeeded'];
      if(data) {
        self.loadData(data);
      }

      if(initialize) {
        self.nodeTooltip = ko.pureComputed(function() {
          var subLabel = (self.isMain() ? nodesViewModel.subLabel() : nodesViewModel.itemLabel());
          if(self.isMain()) {
            var tooltipText = '<h5>' + self.name() + ':</h5>' +
                              (self.description() ? '<p>' + self.description() + '</p><br>' : '') +
                              '<b>' + nodesViewModel.subLabel() + ':</b><span> ' + self.children().length + '</span><br>' +
                              '<b>' + nodesViewModel.itemLabel() + 's:</b><span> ' + self.findLeaves().length + '</span><br>' +
                              '<b>Have ' + nodesViewModel.triedLabel() + ':</b><span> ' + self.numLeavesHaveTried() + '</span><br>' +
                              '<b>Need:</b><span> ' + self.leavesNeeded() + '</span><br>';
          } else {
            var tooltipText = '<h5>' + self.name() + ':</h5>' +
                              (self.description() ? '<p>' + self.description() + '</p><br>' : '') +
                              '<b>' + nodesViewModel.itemLabel() + 's:</b><span> ' + self.children().length + '</span><br>' +
                              '<b>Have ' + nodesViewModel.triedLabel() + ':</b><span> ' + self.numLeavesHaveTried() + '</span><br>' +
                              '<b>Need:</b><span> ' + self.leavesNeeded() + '</span><br>';
          }
          return tooltipText;
        });
        self.nodeDescriptionTooltip = ko.pureComputed(function() {
          return (self.description() ? self.description() : '');
        });
        self.nodeReviewTooltip = ko.pureComputed(function() {
          return (self.review() ? self.review() : '');
        });
        self.leavesNeeded = ko.pureComputed(function() {
          var needed = 0;
          var leaves = self.findLeaves();
          for(var indx=0; indx<leaves.length; indx++) {
            if(leaves[indx].need()) {
              needed++;
            }
          }
          return needed;
        });
        self.image = ko.computed(function() {
          var image = '';
          if(nodesViewModel.type() === 'books') {
            image = 'images/book.jpeg';
          } else if(nodesViewModel.type() === 'beer') {
            image = "images/beer.png";
          } else if(nodesViewModel.type() === 'wine') {
            image = "images/wine.png";
          } else if(nodesViewModel.type() === 'spirits') {
            image = "images/spirits.png";
          } else if(nodesViewModel.type() === 'campgrounds') {
            image = "images/camping.png";
          } else if(nodesViewModel.type() === 'tv') {
            image = "images/tv.png";
          }
          return image;
        })
      }
    }

    Node.prototype.isMain = function() {
      var self = this;
      return self.parentId() == nodesViewModel.rootNode.id();
    }

    Node.prototype.toggleNeed = function() {
      var self = this;
      self.need(!self.need());
    }

    Node.prototype.setDateTried = function() {
      var self = this;
      if(self.haveTried() && !self.dateTried()) {
        var date = new Date();
        self.dateTried((date.getMonth()+1)+'/'+date.getDate()+'/'+date.getFullYear());
      }
      if(!self.haveTried()) {
        self.dateTried(null);
      }
    }

    Node.prototype.setDateReviewed = function() {
      var self = this;
      if(self.review() && !self.dateReviewed()) {
        var date = new Date();
        self.dateReviewed((date.getMonth()+1)+'/'+date.getDate()+'/'+date.getFullYear());
      }
    }

    Node.prototype.findLeaves = function(leaves = []) {
      var self = this;
      if(self.children().length === 0) {
        return leaves.push(self);
      }
      self.children().forEach(function(child) {
        leaves.concat(child.findLeaves(leaves));
      })
      return leaves;
    }

    Node.prototype.numLeavesHaveTried = function() {
      var self = this;
      var leaves = self.findLeaves();
      var count = 0;
      for(var indx=0; indx<leaves.length; indx++) {
        if(leaves[indx].haveTried()) {
          count++;
        }
      }
      return count;
    }

    Node.prototype.leavesHaveTried = function() {
      var self = this;
      var leaves = self.findLeaves();
      for(var indx=0; indx<leaves.length; indx++) {
        if(leaves[indx].haveTried()) {
          return true;
        }
      }
      return false;
    }

    Node.prototype.allLeavesHaveTried = function() {
      var self = this;
      var leaves = self.findLeaves();
      for(var indx=0; indx<leaves.length; indx++) {
        if(!leaves[indx].haveTried()) {
          return false;
        }
      }
      return true;
    }

    Node.prototype.leavesHaveReviewed = function() {
      var self = this;
      var leaves = self.findLeaves();
      for(var indx=0; indx<leaves.length; indx++) {
        if(leaves[indx].review()) {
          return true;
        }
      }
      return false;
    }

    Node.prototype.leavesHaveRating = function() {
      var self = this;
      var leaves = self.findLeaves();
      for(var indx=0; indx<leaves.length; indx++) {
        if(leaves[indx].rating() !== null && leaves[indx].rating() !== '') {
          return true;
        }
      }
      return false;
    }

    Node.prototype.averageRating = function() {
      var self = this;
      var numRated = 0;
      var sumRating = 0;
      var leaves = self.findLeaves();
      for(var indx=0; indx<leaves.length; indx++) {
        if(leaves[indx].rating() !== null && leaves[indx].rating() !== '') {
          numRated++;
          sumRating += Math.floor(leaves[indx].rating());
        }
      }
      if(numRated === 0) {
        return null;
      } else {
        return Math.round(sumRating / numRated);
      }
    }

    Node.prototype.loadData = function(data) {
      var self = this;
      Object.keys(data).forEach(function(aspect) {
        // dynamically set the Node's aspects based on the JSON data
        if(data[aspect] && typeof data[aspect] === 'object') {
          self[aspect] = ko.observable({});
          Object.keys(data[aspect]).forEach( function(nodeInfoAspect) {
            if(typeof nodeInfoAspect === 'array') {
              self[aspect]()[nodeInfoAspect] = ko.observableArray(data[aspect][nodeInfoAspect]);
            }else {
              self[aspect]()[nodeInfoAspect] = ko.observable(data[aspect][nodeInfoAspect]);
              if(nodeInfoAspect === 'ISBN_13' && data[aspect]) {
                self[aspect]()['ISBN'] = ko.observable(data[aspect][nodeInfoAspect]);
              } else if(nodeInfoAspect === 'ISBN_10' && data[aspect]) {
                self[aspect]()['ISBN'] = ko.observable(data[aspect][nodeInfoAspect]);
              }
            }
          })
        } else {
          self[aspect] = ko.observable(data[aspect]);
        }
      })
    }

    Node.prototype.updateData = function(data) {
      var self = this;
      Object.keys(data).forEach(function(aspect) {
        // dynamically set the Node's aspects based on the passed in data
        if(data[aspect] && typeof data[aspect] === 'object') {
          Object.keys(data[aspect]).forEach( function(nodeInfoAspect) {
            if(!ko.isComputed(self[aspect]()[nodeInfoAspect])) {
              self[aspect]()[nodeInfoAspect](data[aspect][nodeInfoAspect]);
            }
          })
        } else {
          if(!ko.isComputed(self[aspect])) {
            self[aspect](data[aspect]);
          }
        }
      })
    }

    Node.prototype.updateNodeInfoData = function(data) {
      var self = this;
      Object.keys(data).forEach(function(aspect) {
        // dynamically set the Node's aspects based on the JSON data
        if(aspect === 'description' || aspect === 'name') {
          self[aspect](data[aspect]);
        } else {
          self.nodeInfo()[aspect](data[aspect]);
        }
      })
    }

    Node.prototype.sanitize = function() {
      var self = this;
      var sanitizedNode = new Node(false);
      sanitizedNode.forgettableAspects = sanitizedNode.forgettableAspects.concat(['ownerId', 'parentId']);
      Object.keys(self).forEach(function(aspect) {
        if(sanitizedNode.forgettableAspects.indexOf(aspect) === -1) {
          sanitizedNode[aspect] = self[aspect];
        }
      });
      return sanitizedNode;
    }

    Node.prototype.copy = function() {
      var self = this;
      var nodeCopy = new Node();
      Object.keys(self).forEach(function(aspect) {
        if(self.forgettableAspects.indexOf(aspect) === -1) {
          if( self[aspect]() && typeof self[aspect]() === 'object') {
            nodeCopy[aspect] = ko.observable({});
            Object.keys(self[aspect]()).forEach( function(nodeInfoAspect) {
              nodeCopy[aspect]()[nodeInfoAspect]=ko.observable((self[aspect]()[nodeInfoAspect]()));
            })
          } else {
            nodeCopy[aspect]=ko.observable(self[aspect]());
          }
        }
      });
      return nodeCopy;
    }

    Node.prototype.data = function() {
      var self = this;
      var nodeData = {};
      Object.keys(self).forEach(function(aspect) {
        if(self.forgettableAspects.indexOf(aspect) === -1) {
          if(self[aspect]()!== null && typeof self[aspect]() === 'object') {
            nodeData[aspect] = {};
            Object.keys(self[aspect]()).forEach( function(nodeInfoAspect) {
              nodeData[aspect][nodeInfoAspect] = self[aspect]()[nodeInfoAspect]();
            });
          } else {
            nodeData[aspect]=self[aspect]();
          }
        }
      });
      return nodeData;
    }

    Node.prototype.nonNullData = function() {
      var self = this;
      var nodeData = {};
      Object.keys(self).forEach(function(aspect) {
        if(self.forgettableAspects.indexOf(aspect) === -1) {
          if(self[aspect]()!== null && typeof self[aspect]() === 'object') {
            nodeData[aspect] = {};
            Object.keys(self[aspect]()).forEach( function(nodeInfoAspect) {
              if(self[aspect]()[nodeInfoAspect]()) {
                nodeData[aspect][nodeInfoAspect] = self[aspect]()[nodeInfoAspect]();
              }
            });
          } else {
            if(self[aspect]()) {
              nodeData[aspect]=self[aspect]();
            }
          }
        }
      });
      return nodeData;
    }

    var NodesViewModel = function() {
      var self = this;
      self.mainLabels = {'books':'Author',
                        'wine':'Winery',
                        'beer':'Brewery',
                        'spirits':'Distillery',
                        'campgrounds':'State',
                        'videos':'Genre',
                        'other':'Main'}
      self.subLabels = {'books':'Series',
                        'wine':'Type',
                        'beer':'Type',
                        'spirits':'Type',
                        'campgrounds':'Region',
                        'videos':'Series Name/non-series',
                        'other':'Sub'}
      self.itemLabels = {'books':'Book',
                        'wine':'Wine',
                        'beer':'Beer',
                        'spirits':'Spirit',
                        'campgrounds':'Campground',
                        'videos':'Season #/Title',
                        'other':'Item'}
      self.triedLabels = {'books':'Read',
                        'wine':'Tried',
                        'beer':'Tried',
                        'spirits':'Tried',
                        'campgrounds':'Camped',
                        'videos':'Viewed',
                        'other':'Tried'}
      self.sortIndexLabels = {'books':'Series Order',
                             'wine':'n/a',
                             'beer':'n/a',
                             'spirits':'n/a',
                             'campgrounds':'n/a',
                             'videos':'Series Order',
                             'other':'Sort Index'}
      self.nodeInfo1Keys = {'books':'publisher',
                            'wine':'vintage',
                            'beer':'vintage',
                            'spirits':'vintage',
                            'campgrounds':'type',
                            'videos':'provider',
                            'other':'nodeinfo1'}
      self.nodeInfo2Keys = {'books':'publishedDate',
                            'wine':'region',
                            'beer':'region',
                            'spirits':'region',
                            'campgrounds':'dates',
                            'videos':'aired',
                            'other':'nodeinfo2'}
      self.nodeInfo3Keys = {'books':'pageCount',
                            'wine':'ABV',
                            'beer':'ABV',
                            'spirits':'ABV',
                            'campgrounds':'amenities',
                            'videos':'epsiodes',
                            'other':'nodeinfo3'}
      self.nodeInfo4Keys = {'books':'ISBN',
                            'wine':'taste',
                            'beer':'IBU',
                            'spirits':'taste',
                            'campgrounds':'sites',
                            'videos':'length',
                            'other':'nodeinfo4'}
      self.nodeInfo5Keys = {'books':'ASIN',
                            'wine':'color',
                            'beer':'SRM',
                            'spirits':'color',
                            'campgrounds':'cost',
                            'videos':'actors',
                            'other':'nodeinfo5'}
      self.nodeInfo6Keys = {'books':'googleLink',
                            'wine':'link',
                            'beer':'link',
                            'spirits':'link',
                            'campgrounds':'link',
                            'videos':'link',
                            'other':'nodeinfo6'}
      self.nodeInfo1Labels = {'books':'Publisher',
                            'wine':'Vintage',
                            'beer':'Vintage',
                            'spirits':'Vintage',
                            'campgrounds':'Type',
                            'videos':'Provider',
                            'other':'Node Info 1'}
      self.nodeInfo2Labels = {'books':'Published',
                            'wine':'Region',
                            'beer':'Region',
                            'spirits':'Region',
                            'campgrounds':'Dates Open',
                            'videos':'First Aired',
                            'other':'Node Info 2'}
      self.nodeInfo3Labels = {'books':'Pages',
                            'wine':'ABV',
                            'beer':'ABV',
                            'spirits':'ABV',
                            'campgrounds':'Amenities',
                            'videos':'# Episodes',
                            'other':'Node Info 3'}
      self.nodeInfo4Labels = {'books':'ISBN',
                            'wine':'Taste',
                            'beer':'IBU',
                            'spirits':'Taste',
                            'campgrounds':'Site details',
                            'videos':'Avg. Length',
                            'other':'Node Info 4'}
      self.nodeInfo5Labels = {'books':'ASIN',
                            'wine':'Color',
                            'beer':'SRM',
                            'spirits':'Color',
                            'campgrounds':'Cost',
                            'videos':'Actors',
                            'other':'Node Info 5'}
      self.nodeInfo6Labels = {'books':'Link',
                            'wine':'Link',
                            'beer':'Link',
                            'spirits':'Link',
                            'campgrounds':'Link',
                            'videos':'Link',
                            'other':'Node Info 6'}
      self.defaultGoogleIcon = 'G';
      self.defaultItemSaveIcon = 'Save';
      self.defaultItemDeleteIcon = 'Delete';
      self.defaultItemEditIcon = 'Edit'
      self.defaultSpinnerIcon = '<i class="fa fa-spinner fa-spin"></i>';
      self.fillItemFromGoogleIcon = ko.observable(self.defaultGoogleIcon);
      self.itemSaveIcon = ko.observable(self.defaultItemSaveIcon);
      self.itemDeleteIcon = ko.observable(self.defaultItemDeleteIcon);
      self.itemEditIcon = ko.observable(self.defaultItemEditIcon);
      self.defaultAlert = ko.observable();
      self.currentUser = ko.observable();
      self.currentUserId = null;
      self.loggedIn = ko.observable(false);
      self.currentUserPassword = null;
      self.authHeader = null;
      self.previousUser = null;
      self.previousUserPassword = null;
      self.type = ko.observable('books');
      self.types = ko.observableArray([
        {type: ko.observable('books')},
        {type: ko.observable('beer')},
        {type: ko.observable('wine')},
        {type: ko.observable('spirits')},
        {type: ko.observable('campgrounds')},
        {type: ko.observable('videos')},
        {type: ko.observable('other')}
      ]);
      self.mainLabel = ko.observable();
      self.subLabel = ko.observable();
      self.itemLabel = ko.observable();
      self.triedLabel = ko.observable();
      self.sortIndexLabel = ko.observable();
      self.nodeInfo1Key = ko.observable();
      self.nodeInfo2Key = ko.observable();
      self.nodeInfo3Key = ko.observable();
      self.nodeInfo4Key = ko.observable();
      self.nodeInfo5Key = ko.observable();
      self.nodeInfo6Key = ko.observable();
      self.nodeInfo1Label = ko.observable();
      self.nodeInfo2Label = ko.observable();
      self.nodeInfo3Label = ko.observable();
      self.nodeInfo4Label = ko.observable();
      self.nodeInfo5Label = ko.observable();
      self.nodeInfo6Label = ko.observable();
      self.defaultAlert = ko.observable();
      self.enableAddMain = ko.observable(true);
      self.enableAddSub = ko.observable(false);
      self.enableAddItem = ko.observable(false);
      self.mainNodes = ko.observableArray();
      self.selectedMainNode = ko.observable(null);
      self.selectedSubNode = ko.observable(null);
      self.selectedItem = ko.observable(null);
      self.previousSelectedItem = null;
      self.rootNode = null;
      self.adjacencyList = {};
      self.addMainLabel = ko.pureComputed(function() {
        return 'Add ' + self.mainLabel();
      });

      self.addSubLabel = ko.pureComputed(function() {
        return 'Add ' + self.subLabel();
      });

      self.addItemLabel = ko.pureComputed(function() {
        return 'Add ' + self.itemLabel();
      });
    }

    NodesViewModel.prototype.beginLogin = function() {
      var self = this;
      self.previousUser = self.currentUser();
      self.previousUserPassword = self.currentUserPassword;
      $('#login').modal({show: true,
                         backdrop: 'static'});
    }

    NodesViewModel.prototype.cancelLogin = function() {
      var self = this;
      if(self.previousUser) {
        self.currentUser(self.previousUser);
      }
      if(self.previousUserPassword) {
        self.currentUserPassword = self.previousUserPassword;
      }
      $('.nav-link.btn').css({'visibility':'visible'});
    }

    NodesViewModel.prototype.login = function(username, password) {
      var self = this;
      setAlert('');
      var url = secrets['MY_THINGS_SERVER'] + '/admin/check/user/';
      url += encodeURIComponent(username);
      var authHeader = {'Authorization':'Basic ' + btoa(username + ':' + password)};
      self.loggedIn(true);
      return self.ajax('GET', url, {}, authHeader)
      .then(function(data) {
        self.currentUser(username);
        self.currentUserPassword = password;
        self.currentUserId = data.id;
        self.authHeader = {'Authorization':'Basic ' + btoa(self.currentUser() + ':' + self.currentUserPassword)};
      })
      .catch(function(err) {
        $('html').removeClass('waiting');
        if (err.status == 403){
          $('#loginBtn').css({'visibility':'visible'});
          setAlert('Incorrect username or password. Try again', 'alert-danger');
        }
        self.loggedIn(false);
      })
      .then(function(data) {
        $('html').removeClass('waiting');
        if(self.loggedIn()) {
          self.initType();
        }
      })
      .catch(function(err) {
        console.log(err.stack)
      });
    }

    NodesViewModel.prototype.logout = function() {
      var self = this;
      self.currentUser('');
      self.currentUserId = null;
      self.currentUserPassword = '';
      self.authHeader = {};
      if(self.selectedItem()) {
        self.unloadItem();
        $('.mt-item-a').removeClass('active');
        self.selectedItem(null);
        self.selectedSubNode(null);
        self.selectedMainNode(null);
        self.mainNodes.removeAll();
      }
      self.loggedIn(false);
    }

    NodesViewModel.prototype.sortByIndexOrPubDateOrName = function (left, right) {

      if(left.sortIndex() !== null && right.sortIndex() !== null) {
        return (left.sortIndex() == right.sortIndex() ? 0 : (parseInt(left.sortIndex()) < parseInt(right.sortIndex()) ? -1 : 1));
      } else if('publishedDate' in left.nodeInfo() && 'publishedDate' in right.nodeInfo() &&
                left.nodeInfo()['publishedDate']() !== null && right.nodeInfo()['publishedDate']() !== null) {
        var dleft = new Date(left.nodeInfo()['publishedDate']());
        var dright = new Date(right.nodeInfo()['publishedDate']());
        return (dleft == dright ? 0 : (dleft < dright ? -1 : 1));
      } else {
        return (left.name().toLowerCase() == right.name().toLowerCase() ? 0 : (left.name().toLowerCase() < right.name().toLowerCase() ? -1 : 1));
      }
    }

    NodesViewModel.prototype.initType = function() {
      var self = this;
      nodesViewModel.unloadItem();
      nodesViewModel.type($('#typesSelect').val());
      nodesViewModel.setType();
    }

    NodesViewModel.prototype.setLabels = function() {
      var self = this;
      self.mainLabel(self.mainLabels[self.type()]);
      self.subLabel(self.subLabels[self.type()]);
      self.itemLabel(self.itemLabels[self.type()]);
      self.triedLabel(self.triedLabels[self.type()]);
      self.sortIndexLabel(self.sortIndexLabels[self.type()]);
      self.defaultAlert('');
      self.nodeInfo1Key(self.nodeInfo1Keys[self.type()]);
      self.nodeInfo2Key(self.nodeInfo2Keys[self.type()]);
      self.nodeInfo3Key(self.nodeInfo3Keys[self.type()]);
      self.nodeInfo4Key(self.nodeInfo4Keys[self.type()]);
      self.nodeInfo5Key(self.nodeInfo5Keys[self.type()]);
      self.nodeInfo6Key(self.nodeInfo6Keys[self.type()]);
      self.nodeInfo1Label(self.nodeInfo1Labels[self.type()]);
      self.nodeInfo2Label(self.nodeInfo2Labels[self.type()]);
      self.nodeInfo3Label(self.nodeInfo3Labels[self.type()]);
      self.nodeInfo4Label(self.nodeInfo4Labels[self.type()]);
      self.nodeInfo5Label(self.nodeInfo5Labels[self.type()]);
      self.nodeInfo6Label(self.nodeInfo6Labels[self.type()]);
      $('.mt-add-buttons button').tooltip('dispose');
      $('.mt-add-buttons button').tooltip('enable');
    }

    NodesViewModel.prototype.updateItemListTooltips = function() {
      var self = this;
      $('#itemList [data-toggle="tooltip"]').tooltip('enable');
      editItemNodeModel.updateItemEditTooltips();
    }

    NodesViewModel.prototype.updateControlsTooltips = function() {
      var self = this;
      $('#controls [data-toggle="tooltip"]').tooltip('enable');
    }

    NodesViewModel.prototype.setType = function() {
      var self = this;
      self.setLabels();
      $("html").addClass("waiting");
      $('#loadingDialog').modal('show');
      return nodesViewModel.getNodes()
      .then(function() {
        setDefaultAlert();
        $('.fa, .far').css({'visibility':'visible'});
        $('.mt-add-buttons, .nav-item, .nav-link').css({'visibility':'visible'});
        self.updateItemListTooltips();
        self.updateControlsTooltips();
        $('#loadingDialog').modal('hide');
      })
    }

    NodesViewModel.prototype.loadItem = function() {
      var self = this;
      self.selectedItem(self.findNode($('a.mt-item-a.active').attr('mt-data-id')))
      if($('.mt-edit-buttons, .mt-item-form').css('visibility') === 'hidden') {
        // only do this if it is currently hidden
        $('.mt-edit-buttons, .mt-item-form').css({'visibility':'visible'});
      }
      editItemNodeModel.updateItemEditTooltips();
    }

    NodesViewModel.prototype.unloadItem = function() {
      var self = this;
      if($('.mt-edit-buttons, .mt-item-form').css('visibility') === 'visible') {
        // only do this if it is currently visible
        $('.mt-edit-buttons, .mt-item-form').css({'visibility':'hidden'});
      }
    }

    NodesViewModel.prototype.findNode = function(id) {
      // TO DO: make this recursive
      var self = this;
      var foundNode = null;
      for(var indx=0; indx<self.mainNodes().length; indx++) {
        var mainNode = self.mainNodes()[indx];
        if(mainNode.id() == id) {
          foundNode = mainNode;
          break;
        }
        for(var subIndx=0; subIndx< mainNode.children().length; subIndx++) {
          var subNode = mainNode.children()[subIndx];
          if(subNode.id() == id) {
            foundNode = subNode;
            break;
          }
          for(var itemIndx=0; itemIndx<subNode.children().length; itemIndx++) {
            var item = subNode.children()[itemIndx];
            if(item.id() == id) {
              foundNode = item;
              break;
            }
          }
        }
      }
      return foundNode;
    }

    NodesViewModel.prototype.proceedWithMainNodeDelete = function() {
      var self = this;
      var url = secrets['MY_THINGS_SERVER'] + '/node/';
      url += encodeURIComponent(self.selectedMainNode().id());
      self.ajax('DELETE', url, {}, self.authHeader)
      .then(function(response) {
        $("html").removeClass("waiting");
        $('a.mt-main-a').removeClass('active');
        var nodeName = self.selectedMainNode().name();
        var indexToRemove = self.adjacencyList[self.selectedMainNode().parentId()].indexOf(self.selectedMainNode());
        if(indexToRemove !== -1) {
          self.adjacencyList[self.rootNode.id()].splice(indexToRemove, 1);
        }
        self.rootNode.children.remove(self.selectedMainNode());
        self.mainNodes(self.rootNode.children());
        self.selectedMainNode(null);
        self.enableAddSub(false);
        self.enableAddItem(false);
        self.unloadItem();
        $('mt-main-collapse').collapse('hide');
        setAlert('Successfully deleted "' + nodeName + '"', 'alert-success');
      })
      .catch(function(err) {
        $("html").removeClass("waiting");
        if(typeof err.responseJSON !== 'undefined') {
          setAlert(err.responseJSON['error'], 'alert-danger')
        } else {
          var errorMessage = err.state();
          if(err.state() === 'rejected') {
            errorMessage = 'Possible network issue. Please try again later.';
          }
          setAlert('error in NodesViewModel.proceedWithMainNodeDelete ajax call: ' + errorMessage, 'alert-danger')
        }
      });
    }

    NodesViewModel.prototype.beginDeleteMainNode = function() {
      var self = this;
      $('#confirmDeleteMainNode').modal({show: true, backdrop: 'static'});
    }

    NodesViewModel.prototype.beginDeleteSubNode = function() {
      var self = this;
      $('#confirmDeleteSubNode').modal({show: true, backdrop: 'static'});
    }

    NodesViewModel.prototype.beginDeleteItem = function() {
      var self = this;
      $('#confirmDeleteItem').modal({show: true, backdrop: 'static'});
    }

    NodesViewModel.prototype.beginEditItem = function() {
      var self = this;
      editItemNodeModel.populateFields(nodesViewModel.selectedMainNode().copy(),
                                       nodesViewModel.selectedSubNode().copy(),
                                       nodesViewModel.selectedItem().copy());
      editItemNodeModel.updateItemEditTooltips();
      $('#editItemNode').modal({show: true, backdrop: 'static'});
    }

    NodesViewModel.prototype.proceedWithSubNodeDelete = function() {
      var self = this;
      var url = secrets['MY_THINGS_SERVER'] + '/node/';
      url += encodeURIComponent(self.selectedSubNode().id());
      self.ajax('DELETE', url, {}, self.authHeader)
      .then(function(response) {
        $("html").removeClass("waiting");
        $('a.mt-sub-a').removeClass('active');
        var nodeName = self.selectedSubNode().name();
        var indexToRemove = self.adjacencyList[self.selectedSubNode().parentId()].indexOf(self.selectedSubNode());
        if(indexToRemove !== -1) {
          self.adjacencyList[self.selectedMainNode().id()].splice(indexToRemove, 1);
        }
        self.selectedMainNode().children.remove(self.selectedSubNode());
        self.selectedSubNode(null);
        self.enableAddItem(false);
        self.unloadItem();
        $('mt-sub-collapse').collapse('hide');
        setAlert('Successfully deleted "' + nodeName + '"', 'alert-success');
      })
      .catch(function(err) {
        $("html").removeClass("waiting");
        if(typeof err.responseJSON !== 'undefined') {
          setAlert(err.responseJSON['error'], 'alert-danger')
        } else {
          var errorMessage = err.state();
          if(err.state() === 'rejected') {
            errorMessage = 'Possible network issue. Please try again later.';
          }
          setAlert('error in NodesViewModel.proceedWithSubNodeDelete ajax call: ' + errorMessage, 'alert-danger')
        }
      });
    }

    NodesViewModel.prototype.proceedWithItemDelete = function() {
      var self = this;
      var url = secrets['MY_THINGS_SERVER'] + '/node/';
      url += encodeURIComponent(self.selectedItem().id());
      self.itemDeleteIcon(self.defaultSpinnerIcon);
      self.ajax('DELETE', url, {}, self.authHeader)
      .then(function(response) {
        self.itemDeleteIcon(self.defaultItemDeleteIcon);
        $("html").removeClass("waiting");
        $('a.mt-item-a').removeClass('active');
        var nodeName = self.selectedItem().name();
        var indexToRemove = self.adjacencyList[self.selectedItem().parentId()].indexOf(self.selectedItem());
        if(indexToRemove !== -1) {
          self.adjacencyList[self.selectedSubNode().id()].splice(indexToRemove, 1);
        }
        self.selectedSubNode().children.remove(self.selectedItem());
        self.selectedItem(null);
        self.unloadItem();
        setAlert('Successfully deleted "' + nodeName + '"', 'alert-success');
      })
      .catch(function(err) {
        $("html").removeClass("waiting");
        self.itemDeleteIcon(self.defaultItemDeleteIcon);
        if(typeof err.responseJSON !== 'undefined') {
          setAlert(err.responseJSON['error'], 'alert-danger')
        } else {
          var errorMessage = err.state();
          if(err.state() === 'rejected') {
            errorMessage = 'Possible network issue. Please try again later.';
          }
          setAlert('error in NodesViewModel.proceedWithItemDelete ajax call: ' + errorMessage, 'alert-danger')
        }
      });
    }

    NodesViewModel.prototype.beginEditMainNode = function() {
      var self = this;
      editMainNodeModel.name(nodesViewModel.selectedMainNode().name());
      editMainNodeModel.description(nodesViewModel.selectedMainNode().description());
      $('#editMainNode').modal({show: true, backdrop: 'static'});
    }

    NodesViewModel.prototype.proceedWithMainNodeEdit = function(nodeData = {}) {
      // add a main or sub node
      var self = this;
      var url = secrets['MY_THINGS_SERVER'] + '/node/' + self.selectedMainNode().id();
      self.ajax('PUT', url, nodeData, self.authHeader)
      .then(function(node) {
        $("html").removeClass("waiting");
        self.selectedMainNode().name(node.name);
        self.selectedMainNode().description(node.description);
        $('a[mt-data-id="' + self.selectedMainNode().id() + '"] span.mt-tooltip').tooltip('dispose');
        $('a[mt-data-id="' + self.selectedMainNode().id() + '"] span.mt-tooltip').tooltip('enable');
        setAlert('Successfully Edited "' + node.name +'"', 'alert-success');
        self.mainNodes.sort(self.sortByIndexOrPubDateOrName);
      })
      .catch(function(err) {
        $("html").removeClass("waiting");
        if(typeof err.responseJSON !== 'undefined') {
          setAlert(err.responseJSON['error'], 'alert-danger')
        } else {
          var errorMessage = err.state();
          if(err.state() === 'rejected') {
            errorMessage = 'Possible network issue. Please try again later.';
          }
          setAlert('error in NodesViewModel.proceedWithMainNodeEdit ajax call: ' + errorMessage, 'alert-danger')
        }
      });
    }

    NodesViewModel.prototype.beginEditSubNode = function() {
      var self = this;
      editSubNodeModel.name(nodesViewModel.selectedSubNode().name());
      editSubNodeModel.description(nodesViewModel.selectedSubNode().description());
      $('#editSubNode').modal({show: true, backdrop: 'static'});
    }

    NodesViewModel.prototype.proceedWithSubNodeEdit = function(nodeData = {}) {
      // add a main or sub node
      var self = this;
      var url = secrets['MY_THINGS_SERVER'] + '/node/' + self.selectedSubNode().id();
      self.ajax('PUT', url, nodeData, self.authHeader)
      .then(function(node) {
        $("html").removeClass("waiting");
        self.selectedSubNode().name(node.name);
        self.selectedSubNode().description(node.description);
        $('a[mt-data-id="' + self.selectedSubNode().id() + '"] span.mt-tooltip').tooltip('dispose');
        $('a[mt-data-id="' + self.selectedSubNode().id() + '"] span.mt-tooltip').tooltip('enable');
        setAlert('Successfully Edited "' + node.name +'"', 'alert-success');
        self.selectedMainNode().children.sort(self.sortByIndexOrPubDateOrName);
      })
      .catch(function(err) {
        $("html").removeClass("waiting");
        if(typeof err.responseJSON !== 'undefined') {
          setAlert(err.responseJSON['error'], 'alert-danger')
        } else {
          var errorMessage = err.state();
          if(err.state() === 'rejected') {
            errorMessage = 'Possible network issue. Please try again later.';
          }
          setAlert('error in NodesViewModel.proceedWithSubNodeEdit ajax call: ' + errorMessage, 'alert-danger')
        }
      });
    }

    NodesViewModel.prototype.beginAddMain = function() {
      $('#addMainNode').modal({show: true, backdrop: 'static'});
    }

    NodesViewModel.prototype.addNode = function(nodeData={}, alertId='#alertBox') {
      // add a node
      var self = this;
      var url = secrets['MY_THINGS_SERVER'] + '/add/node';
      return self.ajax('POST', url, nodeData, self.authHeader)
      .then(function(node) {
        $("html").removeClass("waiting");
        // build adjacencyList structure
        var addedNode = new Node(true, node);
        self.initNode(addedNode);
        if(!(node.parentId in self.adjacencyList)) {
          self.adjacencyList[node.parentId] = [];
        }
        self.adjacencyList[node.parentId].push(addedNode);
        var mainParent = self.findNode(node.parentId);
        if(mainParent) {
          mainParent.children.push(addedNode);
          mainParent.children.sort(self.sortByIndexOrPubDateOrName);
        } else {
          self.rootNode.children.push(addedNode);
          self.rootNode.children.sort(self.sortByIndexOrPubDateOrName);
          self.mainNodes(self.rootNode.children());
        }

        if(addedNode.parentId() === self.rootNode.id()) {
          $('a.mt-main-a').removeClass('active');
          $('.mt-main-collapse').collapse('hide');
          $('#accordianCollapse_' + addedNode.id()).on('hide.bs.collapse', handleHideMainCollapse);
          $('#accordianCollapse_' + addedNode.id()).on('show.bs.collapse', handleShowMainCollapse);
          self.selectedMainNode(addedNode);
          self.enableAddSub(true);
          $('a[mt-data-id="' + addedNode.id() + '"]').addClass('active');
        } else if(addedNode.parentId() === self.selectedMainNode().id()){
          $('a.mt-sub-a').removeClass('active');
          $('.mt-sub-collapse').collapse('hide');
          $('#accordianCollapse_' + addedNode.id()).on('hide.bs.collapse', handleHideSubCollapse);
          $('#accordianCollapse_' + addedNode.id()).on('show.bs.collapse', handleShowSubCollapse);
          $('#accordianCollapse_' + addedNode.parentId()).collapse('show');
          self.selectedSubNode(addedNode);
          self.enableAddItem(true);
          $('a[mt-data-id="' + addedNode.id() + '"]').addClass('active');
        } else {
          $('a.mt-item-a').removeClass('active');
          $('a[mt-data-id="' + addedNode.id() + '"]').addClass('active');
          self.selectedItem(addedNode);
          self.loadItem()
          $('#accordianCollapse_' + addedNode.parentId()).collapse('show');
          $('#editItemNode').modal("hide");
        }
        setAlert('Successfully Added "' + node.name +'"', 'alert-success');
        $('.fa, .far').css({'visibility':'visible'});
      })
      .catch(function(err) {
        $("html").removeClass("waiting");
        if(typeof err.responseJSON !== 'undefined') {
          setAlert(err.responseJSON['error'], 'alert-danger', alertId)
        } else {
          var errorMessage = err.state();
          if(err.state() === 'rejected') {
            errorMessage = 'Possible network issue. Please try again later.';
          }
          setAlert('error in NodesViewModel.addNode ajax call: ' + errorMessage, 'alert-danger', alertId)
        }
      });
    }

    NodesViewModel.prototype.beginAddSub = function() {
      $('#addSubNode').modal({show: true, backdrop: 'static'});
    }

    NodesViewModel.prototype.beginAddItem = function() {
      var self = this;
      var nodeInfo = {};
      nodeInfo[self.nodeInfo1Key()] = null;
      nodeInfo[self.nodeInfo2Key()] = null;
      nodeInfo[self.nodeInfo3Key()] = null;
      nodeInfo[self.nodeInfo4Key()] = null;
      nodeInfo[self.nodeInfo5Key()] = null;
      nodeInfo[self.nodeInfo6Key()] = null;
      var nodeData = {
        owner: self.currentUser(),
        type: self.type(),
        parentId: self.selectedSubNode().id(),
        nodeInfo: nodeInfo,
        haveTried: false,
        dateTried: null,
        dateReviewed: null,
        rating: null,
        name: '',
        uri: ''
      }
      var newNode = new Node(initialize=true, data=nodeData)
      editItemNodeModel.populateFields(nodesViewModel.selectedMainNode().copy(),
                                       nodesViewModel.selectedSubNode().copy(),
                                       newNode);
      $('#editItemNode').modal({show: true, backdrop: 'static'});
    }

    NodesViewModel.prototype.toggleItemNeed = function() {
      var self = this;
      if(nodesViewModel.selectedItem()) {
        nodesViewModel.selectedItem().toggleNeed();
        nodesViewModel.updateItem();
      }
    }

    NodesViewModel.prototype.updateItem = function() {
      var self = this;
      var url = self.selectedItem().uri().replace('http://', 'https://');
      var saveData = self.selectedItem().sanitize();
      self.itemSaveIcon(self.defaultSpinnerIcon);
      self.ajax('PUT', url, saveData, self.authHeader)
      .then(function(response) {
        self.itemSaveIcon(self.defaultItemSaveIcon);
        $("html").removeClass("waiting");
        setAlert('Successfully updated "' + response.name +'"', 'alert-success');
      })
      .catch(function(err) {
        $("html").removeClass("waiting");
        self.itemSaveIcon(self.defaultItemSaveIcon);
        if(typeof err.responseJSON !== 'undefined') {
          setAlert(err.responseJSON['error'], 'alert-danger')
        } else {
          var errorMessage = err.state();
          if(err.state() === 'rejected') {
            errorMessage = 'Possible network issue. Please try again later.';
          }
          setAlert('error in NodesViewModel ajax call: ' + errorMessage, 'alert-danger')
        }
      });
    }

    NodesViewModel.prototype.getNodes = function() {
      var self = this;
      var url = secrets['MY_THINGS_SERVER'] + '/nodes?';
      url += 'ownerId=' + encodeURIComponent(self.currentUserId);
      url += '&type=' + encodeURIComponent(self.type());
      return self.ajax('GET', url, {}, self.authHeader)
      .then(function(response) {
        $("html").removeClass("waiting");
        // build adjacencyList structure
        self.adjacencyList = {};
        response.nodes.forEach(function(node) {
          if(!(node.parentId in self.adjacencyList)) {
            self.adjacencyList[node.parentId] = [];
          }
          var newNode = new Node(true, node);
          self.initNode(newNode);
          self.adjacencyList[node.parentId].push(newNode);
        });
        self.rootNode = self.buildNodeHierarchy();
        self.mainNodes(self.rootNode.children());
        $('.mt-main-collapse').on('hide.bs.collapse', handleHideMainCollapse);
        $('.mt-sub-collapse').on('hide.bs.collapse', handleHideSubCollapse);
        $('.mt-main-collapse').on('show.bs.collapse', handleShowMainCollapse);
        $('.mt-main-collapse').on('shown.bs.collapse', scrollToSelectedMainNode);
        $('.mt-sub-collapse').on('show.bs.collapse', handleShowSubCollapse);
      });
    }

    NodesViewModel.prototype.initNode = function(node) {
      var self = this;
      if(node.nodeInfo() === null) {
        node.nodeInfo({});
      }
      if(!(self.nodeInfo1Key() in node.nodeInfo())) {
        node.nodeInfo()[self.nodeInfo1Key()] = ko.observable(null);
      }
      if(!(self.nodeInfo2Key() in node.nodeInfo())) {
        node.nodeInfo()[self.nodeInfo2Key()] = ko.observable(null);
      }
      if(!(self.nodeInfo3Key() in node.nodeInfo())) {
        node.nodeInfo()[self.nodeInfo3Key()] = ko.observable(null);
      }
      if(!(self.nodeInfo4Key() in node.nodeInfo())) {
        node.nodeInfo()[self.nodeInfo4Key()] = ko.observable(null);
      }
      if(!(self.nodeInfo5Key() in node.nodeInfo())) {
        node.nodeInfo()[self.nodeInfo5Key()] = ko.observable(null);
      }
      if(!(self.nodeInfo6Key() in node.nodeInfo())) {
        node.nodeInfo()[self.nodeInfo6Key()] = ko.observable(null);
      }
    }

    NodesViewModel.prototype.buildNodeHierarchy = function(node=null, parentId=null) {
      var self = this;
      var sameParentList;
      var children;
      if(parentId in self.adjacencyList) {
        sameParentList = self.adjacencyList[parentId];
      } else {
        // this is a leaf node
        return node;
      }
      sameParentList.forEach(function(sibling) {
        // for each node with  the same parent
        if(node === null) {
          // this is the first time through the recursion
          node = sibling;
        } else {
          node.children.push(sibling);
        }
        self.buildNodeHierarchy(sibling, sibling.id());
      });
      return node;
    }

    NodesViewModel.prototype.ajax = function(method, uri, data, authHeader = {}) {
      var self = this;
      setAlert('');
      $("html").addClass("waiting");
      var request = {
        url: uri,
        type: method,
        contentType: "application/json",
        accepts: "application/json",
        cache: false,
        dataType: 'json',
        data: ko.toJSON(data),
        headers: authHeader
      };
      return Promise.resolve($.ajax(request))
    }

    NodesViewModel.prototype.handleMainClick =  function(node, e) {
      $('a.mt-main-a').removeClass('active');
      $(e.currentTarget).addClass('active');
      nodesViewModel.selectedMainNode(node);
      nodesViewModel.selectedMainNode().children.sort(nodesViewModel.sortByIndexOrPubDateOrName);
      nodesViewModel.enableAddSub(true);
    }

    NodesViewModel.prototype.handleSubClick = function(node, e) {
      $('a.mt-sub-a').removeClass('active');
      $(e.currentTarget).addClass('active');
      nodesViewModel.selectedSubNode(node);
      nodesViewModel.selectedSubNode().children.sort(nodesViewModel.sortByIndexOrPubDateOrName);
      nodesViewModel.enableAddItem(true);
    }

    NodesViewModel.prototype.handleItemClick = function(node, e) {
      $('a.mt-item-a').removeClass('active');
      $(e.currentTarget).addClass('active');
      nodesViewModel.loadItem();
      if($(e.target).hasClass('mt-need')) {
        nodesViewModel.toggleItemNeed();
      }
    }

    var AddMainNodeModel = function() {
      var self = this;
      self.name = ko.observable();
      self.description = ko.observable();
    }

    AddMainNodeModel.prototype.addMainNode = function() {
      var self = this;
      var nodeData = {
        name: self.name(),
        owner: nodesViewModel.currentUser(),
        description: self.description(),
        parentId: nodesViewModel.rootNode.id(),
        type: nodesViewModel.type()
      }
      self.name('');
      self.description('');
      nodesViewModel.addNode(nodeData);
    }

    var AddSubNodeModel = function() {
      var self = this;
      self.name = ko.observable();
      self.description = ko.observable();
    }

    AddSubNodeModel.prototype.addSubNode = function() {
      var self = this;
      var nodeData = {
        name: self.name(),
        owner: nodesViewModel.currentUser(),
        description: self.description(),
        parentId: nodesViewModel.selectedMainNode().id(),
        type: nodesViewModel.type()
      }
      self.name('');
      self.description('');
      nodesViewModel.addNode(nodeData);
    }

    var EditMainNodeModel = function() {
      var self = this;
      self.name = ko.observable();
      self.description = ko.observable();
    }

    EditMainNodeModel.prototype.editMainNode = function() {
      var self = this;
      var nodeData = {
        name: self.name(),
        description: self.description(),
      }
      self.name('');
      self.description('');
      nodesViewModel.proceedWithMainNodeEdit(nodeData);
    }

    var EditSubNodeModel = function() {
      var self = this;
      self.name = ko.observable();
      self.description = ko.observable();
    }

    EditSubNodeModel.prototype.editSubNode = function() {
      var self = this;
      var nodeData = {
        name: self.name(),
        description: self.description(),
      }
      self.name('');
      self.description('');
      nodesViewModel.proceedWithSubNodeEdit(nodeData);
    }

    var EditItemLinkModel = function() {
      var self = this;
      self.itemLink = ko.observable();
    }

    EditItemLinkModel.prototype.editItemLink = function() {
      var self = this;
      var itemLink = self.itemLink();
      self.itemLink('');
      editItemNodeModel.proceedWithEditItemLink(itemLink);
    }

    var EditItemNodeModel = function() {
      var self = this;
      self.mainNode = ko.observable();
      self.subNode = ko.observable();
      self.itemNode = ko.observable()
      self.populateFields();
    }

    EditItemNodeModel.prototype.populateFields = function(mainNode = null, subNode = null, itemNode = null) {
      var self = this;
      self.mainNode(mainNode);
      self.subNode(subNode);
      self.itemNode(self.validateItemNode(itemNode));
    }

    EditItemNodeModel.prototype.validateItemNode = function(itemNode) {
      var self = this;
      if(itemNode !== null) {
        var requiredAspects = ['sortIndex', 'name', 'haveTried', 'dateTried', 'image',
                            'description', 'dateReviewed', 'rating', 'review', 'nodeInfo'];
        var requiredNodeInfoAspects = [nodesViewModel.nodeInfo1Keys[nodesViewModel.type()],
                                    nodesViewModel.nodeInfo2Keys[nodesViewModel.type()],
                                    nodesViewModel.nodeInfo3Keys[nodesViewModel.type()],
                                    nodesViewModel.nodeInfo4Keys[nodesViewModel.type()],
                                    nodesViewModel.nodeInfo5Keys[nodesViewModel.type()],
                                    nodesViewModel.nodeInfo6Keys[nodesViewModel.type()]];
        for(key in requiredAspects) {
          if(!(requiredAspects[key] in itemNode)) {
            if(requiredAspects[key] === 'nodeInfo') {
              itemNode[requiredAspects[key]] = ko.observable({});
            } else {
              itemNode[requiredAspects[key]] = ko.observable(null);
            }
          }
        }
        for(key in requiredNodeInfoAspects) {
          if(!(requiredNodeInfoAspects[key] in itemNode.nodeInfo())) {
            itemNode.nodeInfo()[requiredNodeInfoAspects[key]] = ko.observable(null);
          }
        }
      }
      return itemNode;
    }

    EditItemNodeModel.prototype.editItemNode = function() {
      var self = this;
      self.itemNode().name('');
      self.itemNode().description('');
      var nodeData = {
        name: self.itemNode().name(),
        description: self.itemNode().description(),
      }
      nodesViewModel.proceedWithItemNodeEdit(nodeData);
    }

    EditItemNodeModel.prototype.updateItemEditTooltips = function() {
      var self = this;
      $('#itemDetails [data-toggle="tooltip"]').tooltip('enable');
      $('#editItemNode [data-toggle="tooltip"]').tooltip('enable');
    }

    EditItemNodeModel.prototype.fillItemFromGoogle = function() {
      var self = this;
      if(!('ISBN' in self.itemNode().nodeInfo()) || self.itemNode().nodeInfo()['ISBN']() === null || self.itemNode().nodeInfo()['ISBN']().length ===0) {
        setAlert('No ISBN information in selected ' + nodesViewModel.itemLabel(), 'alert-danger');
        return;
      }
      // remove any dashes
      self.itemNode().nodeInfo()['ISBN'](self.itemNode().nodeInfo()['ISBN']().replace('-','').trim());
      var url = 'https://www.googleapis.com/books/v1/volumes?q=';
      url += encodeURIComponent('ISBN=' + self.itemNode().nodeInfo()['ISBN']());
      url += '&' + encodeURIComponent('key=' + secrets['MY_BOOKS_KEY']);
      nodesViewModel.fillItemFromGoogleIcon(nodesViewModel.defaultSpinnerIcon);
      nodesViewModel.ajax('GET', url)
      .then(function(data) {
        $("html").removeClass("waiting");
        nodesViewModel.fillItemFromGoogleIcon(nodesViewModel.defaultGoogleIcon);
        var parsedData = {};
        if(data.totalItems === 0) {
          setAlert('No books found with ISBN = ' + self.itemNode().nodeInfo()['ISBN'](), 'alert-danger');
        } else {
          if('title' in data.items[0].volumeInfo) {
            parsedData['name'] = data.items[0].volumeInfo.title;
          }
          if('description' in data.items[0].volumeInfo) {
            parsedData['description'] = data.items[0].volumeInfo.description;
          }
          if('publisher' in data.items[0].volumeInfo) {
            parsedData['publisher'] = data.items[0].volumeInfo.publisher;
          }
          if('publishedDate' in data.items[0].volumeInfo) {
            parsedData['publishedDate'] = data.items[0].volumeInfo.publishedDate;
          }
          if('pageCount' in data.items[0].volumeInfo) {
            parsedData['pageCount'] = data.items[0].volumeInfo.pageCount;
          }
          if('industryIdentifiers' in data.items[0].volumeInfo) {
            parsedIsbn = null
            if(data.items[0].volumeInfo.industryIdentifiers.length >= 1) {
              if(data.items[0].volumeInfo.industryIdentifiers.length >= 2) {
                data.items[0].volumeInfo.industryIdentifiers.forEach(function(ident) {
                  if(ident.type === 'ISBN_13') {
                    parsedIsbn = ident.identifier;
                  } else if(!parsedIsbn && ident.type === 'ISBN_10') {
                    parsedIsbn = ident.identifier;
                  }
                })
              } else {
                parsedIsbn = data.items[0].volumeInfo.industryIdentifiers[0].identifier;
              }
            }
            if(parsedIsbn) {
              parsedData['ISBN'] = parsedIsbn;
            }
          }
          if('infoLink' in data.items[0].volumeInfo) {
            parsedData['googleLink'] = data.items[0].volumeInfo.infoLink;
          }
          self.itemNode().updateNodeInfoData(parsedData);
          setAlert('Filled information from books.google.com', 'alert-success');
        }
      })
      .catch(function(err) {
        $("html").removeClass("waiting");
        nodesViewModel.fillItemFromGoogleIcon(nodesViewModel.defaultGoogleIcon);
        if(typeof err.responseJSON !== 'undefined') {
          setAlert(err.responseJSON['error'], 'alert-danger')
        } else {
          var errorMessage = err.state();
          if(err.state() === 'rejected') {
            errorMessage = 'Possible network issue. Please try again later.';
          }
          setAlert('error in NodesViewModel.fillItemFromGoogle ajax call: ' + errorMessage, 'alert-danger')
        }
      })
    }

    EditItemNodeModel.prototype.setDateTriedItem = function() {
      var self = this;
      if(self.itemNode()) {
        self.itemNode().setDateTried();
      }
    }

    EditItemNodeModel.prototype.setDateReviewedItem = function() {
      var self = this;
      if(self.itemNode()) {
        self.itemNode().setDateReviewed();
      }
    }

    EditItemNodeModel.prototype.editItemImage = function() {
      var self = this;
      console.log('Display edit item image dialog');
    }

    EditItemNodeModel.prototype.proceedWithEditItemLink = function(itemLink) {
      var self = this;
      self.itemNode().nodeInfo()[nodesViewModel.nodeInfo6Key()](itemLink);
    }

    EditItemNodeModel.prototype.saveItem = function() {
      var self = this;
      self.setDateReviewedItem();
      self.setDateTriedItem();
      var url = self.itemNode().uri().replace('http://', 'https://');
      if(self.itemNode().uri() === '') {
        // add a new node
        setAlert('','','#editItemNodeAlertBox');
        return nodesViewModel.addNode(self.itemNode().nonNullData(), '#editItemNodeAlertBox');
      }
      var saveData = self.itemNode().sanitize();
      nodesViewModel.itemSaveIcon(nodesViewModel.defaultSpinnerIcon);
      setAlert('','','#editItemNodeAlertBox');
      nodesViewModel.ajax('PUT', url, saveData, nodesViewModel.authHeader)
      .then(function(response) {
        nodesViewModel.itemSaveIcon(nodesViewModel.defaultItemSaveIcon);
        nodesViewModel.selectedItem().updateData(self.itemNode().data());
        $("html").removeClass("waiting");
        setAlert('Successfully Updated "' + nodesViewModel.selectedItem().name() +'"', 'alert-success');
        nodesViewModel.loadItem();
        $("#editItemNode").modal("hide");
      })
      .catch(function(err) {
        $("html").removeClass("waiting");
        nodesViewModel.itemSaveIcon(nodesViewModel.defaultItemSaveIcon);
        if(typeof err.responseJSON !== 'undefined') {
          setAlert(err.responseJSON['error'], 'alert-danger', '#editItemNodeAlertBox')
        } else {
          var errorMessage = err.state();
          if(err.state() === 'rejected') {
            errorMessage = 'Possible network issue. Please try again later.';
          }
          setAlert('error in NodesViewModel ajax call: ' + errorMessage, 'alert-danger', '#editItemNodeAlertBox')
        }
      });
    }

    EditItemNodeModel.prototype.proceedWithItemNodeEdit = function(nodeData = {}) {
      // add a main or sub node
      var self = this;
      var url = secrets['MY_THINGS_SERVER'] + '/node/' + self.subNode().id();
      nodesViewModel.ajax('PUT', url, nodeData, nodesViewModel.authHeader)
      .then(function(node) {
        $("html").removeClass("waiting");
        self.selectedSubNode().name(node.name);
        self.selectedSubNode().description(node.description);
        $('a[mt-data-id="' + self.selectedSubNode().id() + '"] span.mt-tooltip').tooltip('dispose');
        $('a[mt-data-id="' + self.selectedSubNode().id() + '"] span.mt-tooltip').tooltip('enable');
        setAlert('Successfully Edited "' + node.name +'"', 'alert-success');
        self.selectedMainNode().children.sort(self.sortByIndexOrPubDateOrName);
      })
      .catch(function(err) {
        $("html").removeClass("waiting");
        if(typeof err.responseJSON !== 'undefined') {
          setAlert(err.responseJSON['error'], 'alert-danger')
        } else {
          var errorMessage = err.state();
          if(err.state() === 'rejected') {
            errorMessage = 'Possible network issue. Please try again later.';
          }
          setAlert('error in NodesViewModel.proceedWithItemNodeEdit ajax call: ' + errorMessage, 'alert-danger')
        }
      });
    }

    EditItemNodeModel.prototype.proceedWithCancelItemEdit = function() {
      var self = this;
    }

    EditItemNodeModel.prototype.continueItemEdit = function() {
      var self = this;
      $('a.mt-item-a').removeClass('active');
      if(nodesViewModel.previousSelectedItem && nodesViewModel.selectedItem() !== nodesViewModel.previousSelectedItem) {
        nodesViewModel.selectedItem(nodesViewModel.previousSelectedItem);
      }
      $('a[mt-data-id="' + nodesViewModel.selectedItem().id() + '"]').addClass('active');
      nodesViewModel.previousSelectedItem = null;
      $('#enItemEd').prop('checked', true);
    }

    EditItemNodeModel.prototype.beginEditItemLink = function() {
      var self = this;
      editItemLinkModel.itemLink(self.itemNode().nodeInfo()[nodesViewModel.nodeInfo6Key()]());
      $('#editItemLink').modal({show: true, backdrop: 'static'});
    }


    var LoginModel = function() {
      var self = this;
      self.username = ko.observable();
      self.password = ko.observable();
    }

    LoginModel.prototype.login = function() {
      var self = this;
      var username = self.username();
      var password = self.password();
      self.username('');
      self.password('');
      nodesViewModel.login(username, password);
    }

    var handleHideMainCollapse = function (e) {
      if ($(this).is(e.target)) {
        // if a main collapse occurs, make sure the sub divs collapse as well
        // and that the sub and items go inactive
        $('.mt-sub-collapse').collapse('hide');
        $('a.mt-sub-a, a.mt-item-a').removeClass('active');
        nodesViewModel.unloadItem();
        nodesViewModel.selectedSubNode(null);
        nodesViewModel.selectedItem(null);
        nodesViewModel.enableAddItem(false);
        // switch collapse icon to '+'
        nodesViewModel.findNode($('a[href="#' + $(this).attr('id') + '"]').attr('mt-data-id')).collapsed(true);
      }
    }

    var handleHideSubCollapse = function (e) {
      if ($(this).is(e.target)) {
        // if a sub collapse occurs, make sure the items go inactive
        $('a.mt-item-a').removeClass('active');
        nodesViewModel.unloadItem();
        nodesViewModel.selectedItem(null);
        // switch collapse icon to '+'
        nodesViewModel.findNode($('a[href="#' + $(this).attr('id') + '"]').attr('mt-data-id')).collapsed(true);
      }
    }

    var handleShowMainCollapse = function (e) {
      if ($(this).is(e.target)) {
        // switch collapse icon to '-'
        nodesViewModel.findNode($('a[href="#' + $(this).attr('id') + '"]').attr('mt-data-id')).collapsed(false);
      }
    }

    var handleShowSubCollapse = function (e) {
      if ($(this).is(e.target)) {
        // switch collapse icon to '-'
        nodesViewModel.findNode($('a[href="#' + $(this).attr('id') + '"]').attr('mt-data-id')).collapsed(false);
      }
    }

    var scrollToSelectedMainNode = function() {
      $('#accordianMain').animate({
         scrollTop: $('#accordianMain').scrollTop() +
                      $('a[mt-data-id="' + nodesViewModel.selectedMainNode().id() + '"]').offset().top -
                      $('#accordianMain').offset().top
      });
    }

    var scrollToSelectedSubNode = function() {
      $('#accordianMain').animate({
         scrollTop: $('#accordianMain').scrollTop() +
                      $('a[mt-data-id="' + nodesViewModel.selectedSubNode().id() + '"]').offset().top -
                      $('#accordianMain').offset().top
      });
    }

    var scrollToSelectedItem = function() {
      $('#accordianMain').animate({
         scrollTop: $('#accordianMain').scrollTop() +
                      $('a[mt-data-id="' + nodesViewModel.selectedItem().id() + '"]').offset().top -
                      $('#accordianMain').offset().top
      });
    }

    setAlert('');
    nodesViewModel = new NodesViewModel();
    addMainNodeModel = new AddMainNodeModel();
    addSubNodeModel = new AddSubNodeModel();
    editMainNodeModel = new EditMainNodeModel();
    editSubNodeModel = new EditSubNodeModel();
    editItemNodeModel = new EditItemNodeModel();
    editItemLinkModel = new EditItemLinkModel();
    loginModel = new LoginModel();
    ko.applyBindings(nodesViewModel, $('#mainBody')[0]);
    ko.applyBindings(addMainNodeModel, $('#addMainNode')[0]);
    ko.applyBindings(addSubNodeModel, $('#addSubNode')[0]);
    ko.applyBindings(editMainNodeModel, $('#editMainNode')[0]);
    ko.applyBindings(editSubNodeModel, $('#editSubNode')[0]);
    ko.applyBindings(editItemNodeModel, $('#editItemNode')[0]);
    ko.applyBindings(editItemLinkModel, $('#editItemLink')[0]);
    ko.applyBindings(loginModel, $('#login')[0]);
    $('#typesSelect').on('change', nodesViewModel.initType);
    $('#itemNodeTried').on('change', editItemNodeModel.setDateTriedItem.bind(editItemNodeModel));
    $(document).keypress(function(e) {
      if(e.which == 13) {
        if(document.activeElement.id === 'itemNodeInfo4' && nodesViewModel.nodeInfo4Key() === 'ISBN') {
          // ISBN
          e.preventDefault();
          editItemNodeModel.fillItemFromGoogle();
        } else {
          if($('.modal-open').length) {
            e.preventDefault();
            $('.modal.show').find('button.btn-primary').click();
          }
        }
      }
    });
    $('#login').on('shown.bs.modal', function () {
      $('#inputUsername').trigger('focus');
    });
    $('#editMainNode').on('shown.bs.modal', function () {
      $('#editMainNodeName').trigger('focus');
    });
    $('#editSubNode').on('shown.bs.modal', function () {
      $('#editSubNodeName').trigger('focus');
    });
    $('#editItemNode').on('shown.bs.modal', function () {
      $('#itemNodeName').trigger('focus');
    });
    $('#editItemLink').on('shown.bs.modal', function () {
      $('#editLink').trigger('focus');
    });
    $('#addMainNode').on('shown.bs.modal', function () {
      $('#inputMainNodeName').trigger('focus');
    });
    $('#addSubNode').on('shown.bs.modal', function () {
      $('#inputSubNodeName').trigger('focus');
    });
    $("html").addClass("waiting");
    Promise.resolve($.ajax({
      cache: false,
      url: "my_things/.secrets.json",
      dataType: "json"
    }))
    .catch(function(err) {
      $("html").removeClass("waiting");
      var errorMessage = err.state();
      if(err.state() === 'rejected') {
        errorMessage = 'Possible network issue. Please try again later.';
      }
      setAlert('error getting secrets file: ' + errorMessage, 'alert-danger');
    })
    .then(function(jsonSecrets) {
      $("html").removeClass("waiting");
      secrets = jsonSecrets;
    }) // .then after getting secrets
    .then(function() {
      nodesViewModel.beginLogin();
    })
    </script>
    <script src="popper/popper.js-1.14.3/dist/umd/popper.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <!-- Latest compiled and minified JavaScript -->
    <script src="bootstrap/bootstrap-4.1.2/js/bootstrap.min.js"></script>
  </body>
</html>
